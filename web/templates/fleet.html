{{define "title"}}Fleet — Legator{{end}}

{{define "header"}}
<div>
  <h1 class="page-title">Fleet</h1>
  <span class="page-meta">{{.Summary.Total}} probes · v{{.Version}}</span>
</div>
{{end}}

{{define "content"}}
<section class="panel">
  <div class="stat-row">
    <span>Online: <strong id="cnt-online">{{.Summary.Online}}</strong></span>
    <span>Offline: <strong id="cnt-offline">{{.Summary.Offline}}</strong></span>
    <span>Degraded: <strong id="cnt-degraded">{{.Summary.Degraded}}</strong></span>
    <span>Total: <strong id="cnt-total">{{.Summary.Total}}</strong></span>
    <span class="right"><span class="dot dot-pending" id="sse-dot"></span><span id="sse-status">connecting…</span></span>
  </div>
</section>

<section class="grid-two">
  <section class="panel">
    <div class="panel-header">
      <h2 class="panel-title">Probes</h2>
    </div>
    <div class="table-wrap">
      <table class="data-table">
        <thead>
          <tr>
            <th>Status</th>
            <th>Hostname</th>
            <th>Probe ID</th>
            <th>OS/Arch</th>
            <th>Policy</th>
            <th>Health</th>
            <th>Tags</th>
            <th>Last Seen</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="fleet-body">
          {{if .Probes}}{{range .Probes}}
          <tr class="probe-row" data-probe-id="{{.ID}}" onclick="location.href='/probe/'+encodeURIComponent('{{.ID}}')">
            <td><span class="dot dot-{{statusClass .Status}}"></span>{{humanizeStatus .Status}}</td>
            <td>{{if .Hostname}}{{.Hostname}}{{else}}-{{end}}</td>
            <td class="id-text">{{.ID}}</td>
            <td>{{if .OS}}{{.OS}}/{{.Arch}}{{else}}-{{end}}</td>
            <td>{{.PolicyLevel}}</td>
            <td>
              {{if .Health}}
              <div class="health-meter">
                <span class="health-track"><span class="health-fill {{if ge .Health.Score 80}}ok{{else if ge .Health.Score 50}}warn{{else}}bad{{end}}" style="width:{{.Health.Score}}%"></span></span>
                <span class="health-score">{{.Health.Score}}%</span>
              </div>
              {{else}}
              <span class="muted">—</span>
              {{end}}
            </td>
            <td>{{if .Tags}}{{range .Tags}}<span class="tag">{{.}}</span>{{end}}{{else}}<span class="muted">—</span>{{end}}</td>
            <td>{{formatLastSeen .LastSeen}}</td>
            <td><a href="/probe/{{.ID}}/chat" onclick="event.stopPropagation()" class="btn">chat</a></td>
          </tr>
          {{end}}{{else}}
          <tr><td colspan="9" class="empty-state">No probes registered yet.</td></tr>
          {{end}}
        </tbody>
      </table>
    </div>
  </section>

  <aside class="panel">
    <div class="panel-header">
      <h2 class="panel-title">Activity Feed</h2>
      <span class="panel-sub" id="feed-count">0 events</span>
    </div>
    <div class="feed" id="feed">
      <div class="feed-item muted">Waiting for fleet events…</div>
    </div>
  </aside>
</section>
{{end}}

{{define "scripts"}}
<script>
(() => {
  const MAX_FEED = 100;
  let feedCount = 0;

  function dotClass(status) {
    const s = (status || '').toLowerCase();
    if (s === 'online') return 'dot-online';
    if (s === 'offline') return 'dot-offline';
    if (s === 'degraded') return 'dot-degraded';
    return 'dot-pending';
  }

  function healthClass(score) {
    if (score >= 80) return 'ok';
    if (score >= 50) return 'warn';
    return 'bad';
  }

  function ago(value) {
    if (!value) return '—';
    const d = Math.max(0, Math.floor((Date.now() - new Date(value)) / 1000));
    if (d < 60) return d + 's ago';
    if (d < 3600) return Math.floor(d / 60) + 'm ago';
    if (d < 86400) return Math.floor(d / 3600) + 'h ago';
    return Math.floor(d / 86400) + 'd ago';
  }

  function hms(ts) {
    const d = new Date(ts || Date.now());
    return String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0') + ':' + String(d.getSeconds()).padStart(2, '0');
  }

  function typeTag(type) {
    const t = String(type || 'event');
    if (t.startsWith('command.')) return '<span class="tag">cmd</span>';
    if (t.startsWith('probe.')) return '<span class="tag">probe</span>';
    if (t.startsWith('approval.')) return '<span class="tag">approval</span>';
    return '<span class="tag">' + t.split('.')[0] + '</span>';
  }

  function updateCounter(id, value) {
    const node = document.getElementById(id);
    if (node) node.textContent = String(value);
  }

  function refreshFleet() {
    fetch('/api/v1/probes', { cache: 'no-store' })
      .then((r) => r.json())
      .then((probes) => {
        const rows = Array.isArray(probes) ? probes : [];
        const body = document.getElementById('fleet-body');
        body.innerHTML = '';

        if (!rows.length) {
          body.innerHTML = '<tr><td colspan="9" class="empty-state">No probes registered yet.</td></tr>';
          updateCounter('cnt-online', 0);
          updateCounter('cnt-offline', 0);
          updateCounter('cnt-degraded', 0);
          updateCounter('cnt-total', 0);
          return;
        }

        let online = 0;
        let offline = 0;
        let degraded = 0;

        rows.forEach((p) => {
          const status = String(p.status || 'pending').toLowerCase();
          if (status === 'online') online += 1;
          else if (status === 'offline') offline += 1;
          else if (status === 'degraded') degraded += 1;

          const tr = document.createElement('tr');
          tr.className = 'probe-row';
          tr.dataset.probeId = p.id;
          tr.onclick = () => { location.href = '/probe/' + encodeURIComponent(p.id); };

          const tags = Array.isArray(p.tags) && p.tags.length
            ? p.tags.map((tag) => '<span class="tag">' + tag + '</span>').join(' ')
            : '<span class="muted">—</span>';

          const health = p.health && typeof p.health.score === 'number'
            ? '<div class="health-meter"><span class="health-track"><span class="health-fill ' + healthClass(p.health.score) + '" style="width:' + p.health.score + '%"></span></span><span class="health-score">' + p.health.score + '%</span></div>'
            : '<span class="muted">—</span>';

          tr.innerHTML = ''
            + '<td><span class="dot ' + dotClass(status) + '"></span>' + status + '</td>'
            + '<td>' + (p.hostname || '-') + '</td>'
            + '<td class="id-text">' + p.id + '</td>'
            + '<td>' + (p.os ? (p.os + '/' + (p.arch || '-')) : '-') + '</td>'
            + '<td>' + (p.policy_level || 'observe') + '</td>'
            + '<td>' + health + '</td>'
            + '<td>' + tags + '</td>'
            + '<td>' + ago(p.last_seen) + '</td>'
            + '<td><a href="/probe/' + encodeURIComponent(p.id) + '/chat" onclick="event.stopPropagation()" class="btn">chat</a></td>';

          body.appendChild(tr);
        });

        updateCounter('cnt-online', online);
        updateCounter('cnt-offline', offline);
        updateCounter('cnt-degraded', degraded);
        updateCounter('cnt-total', rows.length);
      })
      .catch(() => {});
  }

  function addFeedItem(evt) {
    const feed = document.getElementById('feed');
    const item = document.createElement('div');
    const pid = evt.probe_id ? ' <span class="id-text">' + evt.probe_id.slice(0, 12) + '</span>' : '';
    item.className = 'feed-item';
    item.innerHTML = '<span class="muted">' + hms(evt.timestamp) + '</span> ' + typeTag(evt.type) + pid + ' ' + (evt.summary || 'event');
    feed.prepend(item);

    feedCount += 1;
    while (feed.children.length > MAX_FEED) {
      feed.removeChild(feed.lastChild);
    }
    document.getElementById('feed-count').textContent = feedCount + ' events';
  }

  const dot = document.getElementById('sse-dot');
  const status = document.getElementById('sse-status');
  const handlers = {
    onopen: () => {
      dot.className = 'dot dot-online';
      status.textContent = 'live';
    },
    onerror: () => {
      dot.className = 'dot dot-offline';
      status.textContent = 'reconnecting…';
    },
  };

  [
    'probe.connected', 'probe.disconnected', 'probe.offline', 'probe.registered',
    'command.dispatched', 'command.completed', 'command.failed',
    'approval.needed', 'approval.decided', 'policy.changed', 'chat.message',
  ].forEach((eventName) => {
    handlers[eventName] = (evt) => {
      addFeedItem(evt);
      if (eventName.startsWith('probe.') || eventName === 'command.completed' || eventName === 'command.failed') {
        refreshFleet();
      }
    };
  });

  refreshFleet();
  if (window.LegatorUI && window.LegatorUI.connectSSE) {
    window.LegatorUI.connectSSE(handlers);
  }
  setInterval(refreshFleet, 30000);
})();
</script>
{{end}}
