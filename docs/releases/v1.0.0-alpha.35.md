# v1.0.0-alpha.35 — Stage 3.9.2 alert routing + escalation policy as code

## Highlights

### 1) Policy-as-code routing for alerts

Introduced `RoutingPolicy` and `EscalationPolicy` as first-class, persistable entities that determine
where and how alerts are routed when they fire.

**RoutingPolicy** defines:
- `owner_label` / `owner_contact` — who owns the alert domain
- `runbook_url` — canonical runbook for this ownership tier
- `escalation_policy_id` — reference to an EscalationPolicy
- `matchers` — AND-chained criteria matching on `severity`, `condition_type`, `rule_name`, or `tag`
- `priority` — integer precedence; higher wins when multiple policies match
- `is_default` — fallback policy when no matchers hit

**EscalationPolicy** defines ordered steps:
- `order` — 1-based step number
- `target` / `target_type` — who to notify (email, webhook, team, oncall)
- `delay_minutes` — minutes after alert fires before this step activates
- `runbook_url` — optional step-level runbook override

### 2) Deterministic routing resolution with explainability

The `Resolve(RoutingContext)` function determines which policy applies with full explainability:

- `explain.matched_by` — which matcher criterion caused the selection
- `explain.fallback_used` — `true` when the default fallback policy was used
- `explain.reason` — human-readable rationale string

Precedence rules:
1. Non-default policies whose matchers all match — highest `priority` wins
2. If none match, the highest-priority `is_default` policy is used (fallback)
3. If no policies exist, a bare "no routing policies configured" outcome is returned

### 3) Routing wired into alert engine delivery (additive)

Each event delivered on the event bus and to webhooks is now a `DeliveredAlertEvent`:
```
{
  ...AlertEvent fields (unchanged)...
  "routing": {
    "policy_id": "...",
    "policy_name": "...",
    "owner_label": "team-ops",
    "owner_contact": "ops@example.com",
    "runbook_url": "https://...",
    "escalation_policy_id": "...",
    "escalation_steps": [...],
    "explain": {
      "matched_by": "condition_type=probe_offline",
      "fallback_used": false,
      "reason": "matched by condition_type=probe_offline"
    }
  }
}
```

Existing consumers reading only `AlertEvent` fields are unaffected (additive).

### 4) Optional severity field on AlertCondition

`AlertCondition.severity` (string, omitempty) enables severity-based routing matchers.
Valid values: `"critical"`, `"warning"`, `"info"`. Old rules without this field
deserialise with `severity == ""`.

### 5) New API routes [compat:additive]

| Method | Path | Permission |
|--------|------|------------|
| GET | `/api/v1/alerts/routing/policies` | fleet:read |
| POST | `/api/v1/alerts/routing/policies` | fleet:write |
| GET | `/api/v1/alerts/routing/policies/{id}` | fleet:read |
| PUT | `/api/v1/alerts/routing/policies/{id}` | fleet:write |
| DELETE | `/api/v1/alerts/routing/policies/{id}` | fleet:write |
| POST | `/api/v1/alerts/routing/resolve` | fleet:read |
| GET | `/api/v1/alerts/escalation/policies` | fleet:read |
| POST | `/api/v1/alerts/escalation/policies` | fleet:write |
| GET | `/api/v1/alerts/escalation/policies/{id}` | fleet:read |
| PUT | `/api/v1/alerts/escalation/policies/{id}` | fleet:write |
| DELETE | `/api/v1/alerts/escalation/policies/{id}` | fleet:write |

## Compatibility

**[compat:additive]** — no existing routes, fields, or behaviours removed or renamed.
New fields on delivered alert events are additive JSON fields.
New `AlertCondition.severity` field is `omitempty`; existing rules unaffected.
`docs/contracts/api-v1-stable-routes.txt` baseline updated with all new routes.

## Tests

29 new tests covering:
- Matcher logic (eq/contains/prefix, unknown fields, case insensitivity)
- RoutingPolicy CRUD (create, get, list, update, delete, not-found)
- EscalationPolicy CRUD (create, get, update with additional steps, delete)
- Routing resolution: exact match, priority precedence, fallback-to-default,
  specific-beats-default, escalation steps resolved, multi-tag matching
- Explainability fields (matched_by, reason populated)
- HTTP handler validation gates (missing name, missing owner_label, invalid step order)
- HTTP handler not-found and list responses
