---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.20.1
  name: agentruns.core.infraagent.io
spec:
  group: core.infraagent.io
  names:
    kind: AgentRun
    listKind: AgentRunList
    plural: agentruns
    singular: agentrun
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .spec.agentRef
      name: Agent
      type: string
    - jsonPath: .status.phase
      name: Phase
      type: string
    - jsonPath: .spec.trigger
      name: Trigger
      type: string
    - jsonPath: .status.usage.wallClockMs
      name: Duration
      priority: 1
      type: integer
    - jsonPath: .status.usage.totalTokens
      name: Tokens
      priority: 1
      type: integer
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: |-
          AgentRun is the Schema for the agentruns API.
          It is an immutable audit record of a single agent execution â€”
          every action, pre-flight check, block, escalation, and finding.
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: AgentRunSpec defines the immutable configuration for a run.
            properties:
              agentRef:
                description: agentRef is the name of the InfraAgent that owns this
                  run.
                type: string
              environmentRef:
                description: environmentRef is the name of the AgentEnvironment used.
                type: string
              modelUsed:
                description: modelUsed is the actual provider/model resolved from
                  the tier.
                type: string
              trigger:
                description: trigger describes what initiated this run.
                enum:
                - scheduled
                - webhook
                - manual
                type: string
            required:
            - agentRef
            - environmentRef
            - trigger
            type: object
          status:
            description: |-
              AgentRunStatus defines the observed state of an AgentRun.
              Once phase reaches a terminal state (Succeeded/Failed/Escalated/Blocked),
              no field is ever modified again.
            properties:
              actions:
                description: actions is the ordered list of every tool call attempted.
                items:
                  description: ActionRecord captures a single tool call attempt.
                  properties:
                    escalation:
                      description: escalation captures escalation details when an
                        action is blocked.
                      properties:
                        channel:
                          description: channel is where the escalation was sent.
                          type: string
                        message:
                          description: message is the escalation content.
                          type: string
                        timestamp:
                          description: timestamp is when the escalation was sent.
                          format: date-time
                          type: string
                      required:
                      - channel
                      - message
                      - timestamp
                      type: object
                    preFlightCheck:
                      description: preFlightCheck captures the pre-flight check results.
                      properties:
                        allowListCheck:
                          description: allowListCheck indicates whether the action
                            matches the allow list.
                          type: string
                        autonomyCheck:
                          description: autonomyCheck indicates whether the autonomy
                            level permits this action.
                          type: string
                        dataImpactCheck:
                          description: dataImpactCheck indicates whether the action
                            impacts data resources.
                          type: string
                        dataProtection:
                          description: dataProtection indicates whether hardcoded
                            data protection rules blocked this action.
                          type: string
                        reason:
                          description: reason provides a human-readable explanation
                            when a check fails.
                          type: string
                      type: object
                    result:
                      description: result is the tool output or error message.
                      type: string
                    seq:
                      description: seq is the sequence number within this run.
                      format: int32
                      type: integer
                    status:
                      description: status is what happened to this action.
                      enum:
                      - executed
                      - blocked
                      - failed
                      - skipped
                      type: string
                    target:
                      description: target is what the tool acted on (e.g. "pods -n
                        backstage").
                      type: string
                    tier:
                      description: tier is the risk classification of this action.
                      enum:
                      - read
                      - service-mutation
                      - destructive-mutation
                      - data-mutation
                      type: string
                    timestamp:
                      description: timestamp is when this action was attempted.
                      format: date-time
                      type: string
                    tool:
                      description: tool is the tool identifier (e.g. "kubectl.get",
                        "http.post", "mcp.k8sgpt.analyze").
                      type: string
                  required:
                  - seq
                  - status
                  - target
                  - tier
                  - timestamp
                  - tool
                  type: object
                type: array
              completionTime:
                description: completionTime is when the run finished.
                format: date-time
                type: string
              conditions:
                description: conditions represent the current state.
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
                x-kubernetes-list-map-keys:
                - type
                x-kubernetes-list-type: map
              findings:
                description: findings lists noteworthy discoveries.
                items:
                  description: RunFinding records something noteworthy the agent discovered.
                  properties:
                    message:
                      description: message is a human-readable description.
                      type: string
                    resource:
                      description: resource is the Kubernetes resource the finding
                        relates to.
                      type: string
                    severity:
                      description: severity classifies the finding.
                      enum:
                      - info
                      - warning
                      - critical
                      type: string
                  required:
                  - message
                  - severity
                  type: object
                type: array
              guardrails:
                description: guardrails summarises guardrail activity.
                properties:
                  actionsBlocked:
                    description: actionsBlocked is how many actions were blocked by
                      guardrails.
                    format: int32
                    type: integer
                  autonomyCeiling:
                    description: autonomyCeiling is the agent's configured autonomy
                      level.
                    enum:
                    - observe
                    - recommend
                    - automate-safe
                    - automate-destructive
                    type: string
                  budgetUsed:
                    description: budgetUsed reports resource consumption.
                    properties:
                      iterationsUsed:
                        description: iterationsUsed is the actual iterations.
                        format: int32
                        type: integer
                      maxIterations:
                        description: maxIterations is the configured max.
                        format: int32
                        type: integer
                      timeoutMs:
                        description: timeoutMs is the configured max in milliseconds.
                        format: int64
                        type: integer
                      tokenBudget:
                        description: tokenBudget is the configured max.
                        format: int64
                        type: integer
                      tokensUsed:
                        description: tokensUsed is the actual tokens consumed.
                        format: int64
                        type: integer
                      wallClockMs:
                        description: wallClockMs is the actual run duration in milliseconds.
                        format: int64
                        type: integer
                    type: object
                  checksPerformed:
                    description: checksPerformed is the total number of pre-flight
                      checks.
                    format: int32
                    type: integer
                  escalationsTriggered:
                    description: escalationsTriggered is how many escalations were
                      sent.
                    format: int32
                    type: integer
                type: object
              phase:
                description: phase is the current lifecycle phase.
                enum:
                - Pending
                - Running
                - Succeeded
                - Failed
                - Escalated
                - Blocked
                type: string
              report:
                description: report is the agent's human-readable summary.
                type: string
              startTime:
                description: startTime is when the run began.
                format: date-time
                type: string
              usage:
                description: usage summarises resource consumption.
                properties:
                  estimatedCost:
                    description: estimatedCost is the estimated USD cost (based on
                      ModelTierConfig pricing).
                    type: string
                  iterations:
                    description: iterations is the number of tool-call loops.
                    format: int32
                    type: integer
                  tokensIn:
                    description: tokensIn is the input token count.
                    format: int64
                    type: integer
                  tokensOut:
                    description: tokensOut is the output token count.
                    format: int64
                    type: integer
                  totalTokens:
                    description: totalTokens is tokensIn + tokensOut.
                    format: int64
                    type: integer
                  wallClockMs:
                    description: wallClockMs is the total run duration in milliseconds.
                    format: int64
                    type: integer
                type: object
            type: object
        required:
        - spec
        type: object
    served: true
    storage: true
    subresources:
      status: {}
