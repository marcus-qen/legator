{{define "title"}}Audit — Legator{{end}}

{{define "header"}}
<div>
  <h1 class="page-title">Audit</h1>
  <span class="page-meta">Immutable timeline</span>
</div>
{{end}}

{{define "content"}}
<section class="panel">
  <div class="filters">
    <input id="filter-text" type="text" placeholder="Filter by probe, actor, summary…" class="input" />
    <select id="filter-type" class="input">
      <option value="">All event types</option>
      <option value="command">Command</option>
      <option value="probe">Probe</option>
      <option value="approval">Approval</option>
      <option value="policy">Policy</option>
    </select>
  </div>
  <div class="table-wrap">
    <table class="data-table">
      <thead>
        <tr>
          <th>Time</th>
          <th>Type</th>
          <th>Probe</th>
          <th>Actor</th>
          <th>Summary</th>
        </tr>
      </thead>
      <tbody id="audit-body">
        <tr><td colspan="5" class="empty-state">Loading…</td></tr>
      </tbody>
    </table>
  </div>
</section>
{{end}}

{{define "scripts"}}
<script>
(() => {
  let latestEvents = [];

  function typeClass(type) {
    const t = (type || '').toLowerCase();
    if (t.includes('command')) return 'tag-online';
    if (t.includes('register') || t.includes('probe')) return 'tag-pending';
    if (t.includes('approval')) return 'tag-degraded';
    if (t.includes('policy')) return 'tag-offline';
    return '';
  }

  function fmtTime(value) {
    if (!value) return '—';
    return new Date(value).toLocaleString();
  }

  function matchesFilters(event) {
    const textFilter = (document.getElementById('filter-text').value || '').trim().toLowerCase();
    const typeFilter = (document.getElementById('filter-type').value || '').trim().toLowerCase();

    const type = (event.type || '').toLowerCase();
    const probe = (event.probe_id || '').toLowerCase();
    const actor = (event.actor || '').toLowerCase();
    const summary = (event.summary || '').toLowerCase();

    if (typeFilter && !type.includes(typeFilter)) return false;
    if (!textFilter) return true;

    return type.includes(textFilter) || probe.includes(textFilter) || actor.includes(textFilter) || summary.includes(textFilter);
  }

  function render(events) {
    const body = document.getElementById('audit-body');
    const filtered = (events || []).filter(matchesFilters);

    if (!filtered.length) {
      body.innerHTML = '<tr><td colspan="5" class="empty-state">No matching audit events.</td></tr>';
      return;
    }

    body.innerHTML = filtered.map((event, idx) => `
      <tr class="probe-row" onclick="toggleAuditDetail(${idx})">
        <td>${fmtTime(event.timestamp)}</td>
        <td><span class="tag ${typeClass(event.type)}">${event.type || '—'}</span></td>
        <td>${event.probe_id || '—'}</td>
        <td>${event.actor || 'system'}</td>
        <td>${event.summary || '—'}</td>
      </tr>
      <tr id="audit-detail-${idx}" style="display:none;">
        <td colspan="5"><pre class="chat-code">${JSON.stringify(event, null, 2)}</pre></td>
      </tr>
    `).join('');
  }

  window.toggleAuditDetail = function (idx) {
    const row = document.getElementById('audit-detail-' + idx);
    if (!row) return;
    row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
  };

  function refresh() {
    fetch('/api/v1/audit?limit=300', { cache: 'no-store' })
      .then((resp) => resp.json())
      .then((payload) => {
        const events = Array.isArray(payload) ? payload : (payload && Array.isArray(payload.events) ? payload.events : []);
        events.sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0));
        latestEvents = events;
        render(latestEvents);
      })
      .catch(() => {
        document.getElementById('audit-body').innerHTML = '<tr><td colspan="5" class="empty-state">Failed to load audit events.</td></tr>';
      });
  }

  document.getElementById('filter-text').addEventListener('input', () => render(latestEvents));
  document.getElementById('filter-type').addEventListener('change', () => render(latestEvents));

  refresh();
  setInterval(refresh, 10000);
})();
</script>
{{end}}
