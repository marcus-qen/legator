<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Legator Fleet</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace; background: #0d1117; color: #c9d1d9; min-height: 100vh; }
      .app { max-width: 1400px; margin: 0 auto; padding: 20px; }
      header { padding: 24px 0; border-bottom: 1px solid #21262d; margin-bottom: 24px; }
      header h1 { font-size: 24px; color: #58a6ff; font-weight: 600; }
      header p { color: #8b949e; font-size: 14px; margin-top: 4px; }
      .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 24px; }
      .card { background: #161b22; border: 1px solid #21262d; border-radius: 8px; padding: 16px; text-align: center; transition: border-color 0.3s; }
      .card.flash { border-color: #58a6ff; }
      .card span { display: block; font-size: 12px; color: #8b949e; text-transform: uppercase; letter-spacing: 1px; }
      .card strong { display: block; font-size: 28px; margin-top: 4px; }
      .card.online strong { color: #3fb950; }
      .card.offline strong { color: #f85149; }
      .card.degraded strong { color: #d29922; }
      .card.total strong { color: #58a6ff; }
      .grid-2 { display: grid; grid-template-columns: 1fr 360px; gap: 16px; align-items: start; }
      .panel { background: #161b22; border: 1px solid #21262d; border-radius: 8px; overflow: hidden; }
      .panel-header { padding: 16px 20px; border-bottom: 1px solid #21262d; display: flex; justify-content: space-between; align-items: center; }
      .panel-header h2 { font-size: 16px; color: #c9d1d9; }
      .panel-header .sub { font-size: 12px; color: #484f58; }
      .live-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: #3fb950; margin-right: 6px; animation: pulse 2s infinite; }
      .live-dot.disconnected { background: #f85149; animation: none; }
      @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
      table { width: 100%; border-collapse: collapse; }
      th { text-align: left; padding: 10px 16px; font-size: 12px; color: #8b949e; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #21262d; background: #0d1117; position: sticky; top: 0; }
      td { padding: 10px 16px; border-bottom: 1px solid #21262d; font-size: 13px; }
      .btn-chat {
        display: inline-flex; align-items: center; justify-content: center;
        width: 32px; height: 28px; border-radius: 6px;
        background: #21262d; border: 1px solid #30363d;
        text-decoration: none; font-size: 14px;
        transition: background 0.15s, border-color 0.15s;
      }
      .btn-chat:hover { background: #30363d; border-color: #58a6ff; }
      tr.probe-row { cursor: pointer; transition: background 0.15s; }
      tr.probe-row:hover { background: #1c2128; }
      tr.probe-row.highlight { background: #1c2128; transition: background 1s; }
      .dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; vertical-align: middle; }
      .dot-online { background: #3fb950; }
      .dot-offline { background: #f85149; }
      .dot-degraded { background: #d29922; }
      .dot-pending { background: #484f58; }
      .pill { display: inline-block; background: #21262d; color: #8b949e; border-radius: 12px; padding: 2px 8px; font-size: 11px; margin: 1px 2px; }
      .health-bar { display: inline-flex; align-items: center; gap: 6px; }
      .health-fill { height: 6px; border-radius: 3px; min-width: 4px; }
      .health-green { background: #3fb950; }
      .health-yellow { background: #d29922; }
      .health-red { background: #f85149; }
      .health-gray { background: #484f58; }
      .empty-state { text-align: center; padding: 40px; color: #484f58; }
      .table-wrap { overflow-x: auto; }
      /* Activity feed */
      .feed { max-height: 480px; overflow-y: auto; }
      .feed-item { padding: 10px 16px; border-bottom: 1px solid #21262d; font-size: 12px; animation: fadeIn 0.3s ease; }
      .feed-item:first-child { background: #1c2128; }
      .feed-item .ts { color: #484f58; margin-right: 8px; }
      .feed-item .type { font-weight: 600; margin-right: 6px; }
      .feed-item .type.cmd { color: #58a6ff; }
      .feed-item .type.probe { color: #3fb950; }
      .feed-item .type.approval { color: #d29922; }
      .feed-item .type.error { color: #f85149; }
      .feed-empty { padding: 30px; text-align: center; color: #484f58; font-size: 13px; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: none; } }
      @media (max-width: 900px) { .grid-2 { grid-template-columns: 1fr; } .cards { grid-template-columns: repeat(2, 1fr); } }
    </style>
  </head>
  <body>
    <div class="app">
      <header>
        <h1>‚ö° Legator Control Plane</h1>
        <p>Fleet overview and probe management ¬∑ <span id="version">{{.Version}}</span></p>
        <nav style="margin-top:12px;display:flex;gap:16px;font-size:13px">
          <a href="/" style="color:#58a6ff">Fleet</a>
          <a href="/approvals" style="color:#d29922">‚öñÔ∏è Approvals</a>
          <a href="/audit" style="color:#8b949e">üìã Audit</a>
        </nav>
      </header>

      <section class="cards">
        <div class="card online"><span>Online</span><strong id="cnt-online">{{.Summary.Online}}</strong></div>
        <div class="card offline"><span>Offline</span><strong id="cnt-offline">{{.Summary.Offline}}</strong></div>
        <div class="card degraded"><span>Degraded</span><strong id="cnt-degraded">{{.Summary.Degraded}}</strong></div>
        <div class="card total"><span>Total</span><strong id="cnt-total">{{.Summary.Total}}</strong></div>
      </section>

      <section class="grid-2">
        <div class="panel">
          <div class="panel-header">
            <h2>Fleet</h2>
            <span class="sub"><span class="live-dot" id="sse-dot"></span><span id="sse-status">connecting‚Ä¶</span></span>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Status</th>
                  <th>Hostname</th>
                  <th>Probe ID</th>
                  <th>OS/Arch</th>
                  <th>Policy</th>
                  <th>Health</th>
                  <th>Tags</th>
                  <th>Last Seen</th>
                  <th style="width:70px">Actions</th>
                </tr>
              </thead>
              <tbody id="fleet-body">
                {{if .Probes}}{{range .Probes}}
                <tr class="probe-row" data-probe-id="{{.ID}}" onclick="location.href='/probe/'+encodeURIComponent('{{.ID}}')">
                  <td><span class="dot dot-{{statusClass .Status}}"></span>{{humanizeStatus .Status}}</td>
                  <td>{{if .Hostname}}{{.Hostname}}{{else}}-{{end}}</td>
                  <td style="color:#58a6ff">{{.ID}}</td>
                  <td>{{if .OS}}{{.OS}}/{{.Arch}}{{else}}-{{end}}</td>
                  <td>{{.PolicyLevel}}</td>
                  <td>{{if .Health}}<div class="health-bar"><span class="health-fill {{if ge .Health.Score 80}}health-green{{else if ge .Health.Score 50}}health-yellow{{else}}health-red{{end}}" style="width:{{.Health.Score}}px"></span><span>{{.Health.Score}}</span></div>{{else}}<span style="color:#484f58">‚Äî</span>{{end}}</td>
                  <td>{{range .Tags}}<span class="pill">{{.}}</span>{{end}}</td>
                  <td>{{formatLastSeen .LastSeen}}</td>
                  <td><a href="/probe/{{.ID}}/chat" onclick="event.stopPropagation()" class="btn-chat" title="Chat with probe">üí¨</a></td>
                </tr>
                {{end}}{{else}}
                <tr><td colspan="9" class="empty-state">No probes registered yet.</td></tr>
                {{end}}
              </tbody>
            </table>
          </div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <h2>Live Activity</h2>
            <span class="sub" id="feed-count">0 events</span>
          </div>
          <div class="feed" id="feed">
            <div class="feed-empty">Waiting for events‚Ä¶</div>
          </div>
        </div>
      </section>
    </div>

    <script>
      const MAX_FEED = 100;
      let feedCount = 0;

      // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
      function dotClass(s) {
        s = (s||'').toLowerCase();
        return s==='online'?'dot-online':s==='offline'?'dot-offline':s==='degraded'?'dot-degraded':'dot-pending';
      }
      function hClass(sc) { return sc>=80?'health-green':sc>=50?'health-yellow':'health-red'; }
      function ago(v) {
        if (!v) return '‚Äî';
        const d = Math.max(0,Math.floor((Date.now()-new Date(v))/1000));
        if (d<60) return d+'s ago';
        if (d<3600) return Math.floor(d/60)+'m ago';
        if (d<86400) return Math.floor(d/3600)+'h ago';
        return Math.floor(d/86400)+'d ago';
      }
      function hms(ts) {
        const d = new Date(ts);
        return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0')+':'+String(d.getSeconds()).padStart(2,'0');
      }
      function typeTag(t) {
        if (t.startsWith('command.')) return '<span class="type cmd">CMD</span>';
        if (t.startsWith('probe.')) return '<span class="type probe">PROBE</span>';
        if (t.startsWith('approval.')) return '<span class="type approval">APPROVAL</span>';
        return '<span class="type error">'+t.split('.')[0].toUpperCase()+'</span>';
      }

      // ‚îÄ‚îÄ Fleet refresh ‚îÄ‚îÄ
      function refreshFleet() {
        fetch('/api/v1/probes',{cache:'no-store'}).then(r=>r.json()).then(probes => {
          const tb = document.getElementById('fleet-body');
          let on=0, off=0, deg=0;
          tb.innerHTML = '';
          if (!probes||!probes.length) {
            tb.innerHTML = '<tr><td colspan="9" class="empty-state">No probes registered yet.</td></tr>';
            return;
          }
          probes.forEach(p => {
            const s = (p.status||'').toLowerCase();
            if (s==='online') on++; else if (s==='offline') off++; else if (s==='degraded') deg++;
            const tr = document.createElement('tr');
            tr.className = 'probe-row';
            tr.dataset.probeId = p.id;
            tr.onclick = () => location.href='/probe/'+encodeURIComponent(p.id);
            const h = p.health;
            const tags = (p.tags||[]).map(t=>'<span class="pill">'+t+'</span>').join('');
            const hbar = h?'<div class="health-bar"><span class="health-fill '+hClass(h.score)+'" style="width:'+h.score+'px"></span><span>'+h.score+'</span></div>':'<span style="color:#484f58">‚Äî</span>';
            tr.innerHTML = '<td><span class="dot '+dotClass(s)+'"></span>'+s+'</td>'
              +'<td>'+(p.hostname||'-')+'</td>'
              +'<td style="color:#58a6ff">'+p.id+'</td>'
              +'<td>'+(p.os?p.os+'/'+p.arch:'-')+'</td>'
              +'<td>'+(p.policy_level||'observe')+'</td>'
              +'<td>'+hbar+'</td>'
              +'<td>'+tags+'</td>'
              +'<td>'+ago(p.last_seen)+'</td>'
              +'<td><a href="/probe/'+encodeURIComponent(p.id)+'/chat" onclick="event.stopPropagation()" class="btn-chat" title="Chat with probe">üí¨</a></td>';
            tb.appendChild(tr);
          });
          update('cnt-online',on); update('cnt-offline',off);
          update('cnt-degraded',deg); update('cnt-total',probes.length);
        }).catch(()=>{});
      }
      function update(id,val) {
        const el = document.getElementById(id);
        if (el.textContent !== String(val)) {
          el.textContent = val;
          el.closest('.card').classList.add('flash');
          setTimeout(()=>el.closest('.card').classList.remove('flash'), 800);
        }
      }

      // ‚îÄ‚îÄ Activity feed ‚îÄ‚îÄ
      function addFeedItem(evt) {
        const feed = document.getElementById('feed');
        const empty = feed.querySelector('.feed-empty');
        if (empty) empty.remove();

        const div = document.createElement('div');
        div.className = 'feed-item';
        const pid = evt.probe_id ? ' <span style="color:#58a6ff">'+evt.probe_id.slice(0,12)+'</span>' : '';
        div.innerHTML = '<span class="ts">'+hms(evt.timestamp)+'</span>'+typeTag(evt.type)+pid+' '+evt.summary;
        feed.insertBefore(div, feed.firstChild);

        feedCount++;
        while (feed.children.length > MAX_FEED) feed.removeChild(feed.lastChild);
        document.getElementById('feed-count').textContent = feedCount+' events';
      }

      // ‚îÄ‚îÄ SSE connection ‚îÄ‚îÄ
      let es = null;
      function connectSSE() {
        const dot = document.getElementById('sse-dot');
        const status = document.getElementById('sse-status');

        es = new EventSource('/api/v1/events');

        es.onopen = () => {
          dot.classList.remove('disconnected');
          status.textContent = 'live';
        };

        es.onerror = () => {
          dot.classList.add('disconnected');
          status.textContent = 'reconnecting‚Ä¶';
        };

        // Listen for all event types
        const types = ['probe.connected','probe.disconnected','probe.offline','probe.registered',
                       'command.dispatched','command.completed','command.failed',
                       'approval.needed','approval.decided','policy.changed','chat.message'];
        types.forEach(t => {
          es.addEventListener(t, e => {
            try {
              const evt = JSON.parse(e.data);
              addFeedItem(evt);
              // Refresh fleet table on probe/status events
              if (t.startsWith('probe.') || t === 'command.completed' || t === 'command.failed') {
                refreshFleet();
              }
            } catch(err) {}
          });
        });
      }

      // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
      refreshFleet();
      connectSSE();
      // Fallback polling for last-seen relative times
      setInterval(refreshFleet, 30000);
    </script>
  </body>
</html>
