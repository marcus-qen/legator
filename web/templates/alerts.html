{{define "title"}}Alerts — Legator{{end}}

{{define "header"}}
<div>
  <h1 class="page-title">Alerts</h1>
  <span class="page-meta">Rules, active incidents, history</span>
</div>
<div class="right">
  <button class="btn" type="button" id="create-rule-btn">Create Rule</button>
</div>
{{end}}

{{define "content"}}
<section class="panel">
  <div class="panel-header">
    <h2 class="panel-title">Active Alerts</h2>
    <span class="panel-sub" id="active-alert-count">0 firing</span>
  </div>
  <div id="active-alerts" class="feed">
    <p class="muted">Loading active alerts…</p>
  </div>
</section>

<section class="panel">
  <div class="panel-header">
    <h2 class="panel-title">Alert Rules</h2>
    <span class="panel-sub" id="rules-count">0 rules</span>
  </div>
  <div class="table-wrap">
    <table class="data-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Threshold</th>
          <th>Duration</th>
          <th>Tags</th>
          <th>Enabled</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="rules-body">
        <tr><td colspan="7" class="empty-state">Loading rules…</td></tr>
      </tbody>
    </table>
  </div>
</section>

<div class="context-backdrop" data-create-close></div>

<aside class="context-column panel" id="alerts-create-panel" aria-hidden="true">
  <div class="panel-header">
    <h2 class="panel-title">Create Alert Rule</h2>
    <button class="btn" type="button" data-create-close>Close</button>
  </div>

  <form id="create-rule-form" class="feed" autocomplete="off">
    <label>
      <span class="muted">Name</span>
      <input type="text" id="rule-name" class="input" required />
    </label>

    <label>
      <span class="muted">Description</span>
      <input type="text" id="rule-description" class="input" />
    </label>

    <label>
      <span class="muted">Condition Type</span>
      <select id="rule-type" class="input" required>
        <option value="probe_offline">probe_offline</option>
        <option value="disk_threshold">disk_threshold</option>
        <option value="cpu_threshold">cpu_threshold</option>
      </select>
    </label>

    <label id="threshold-wrap">
      <span class="muted">Threshold</span>
      <input type="number" id="rule-threshold" class="input" min="0" step="0.1" value="90" />
    </label>

    <label>
      <span class="muted">Duration</span>
      <input type="text" id="rule-duration" class="input" value="2m" required />
    </label>

    <label>
      <span class="muted">Tags</span>
      <input type="text" id="rule-tags" class="input" placeholder="prod, edge, critical" />
    </label>

    <label>
      <input type="checkbox" id="rule-enabled" checked />
      <span>Enabled</span>
    </label>

    <div class="actions-row">
      <button type="button" class="btn" data-create-close>Cancel</button>
      <button type="submit" class="btn btn-primary">Create</button>
    </div>
  </form>
</aside>
{{end}}

{{define "scripts"}}
<script>
(() => {
  const state = {
    rules: [],
    history: {},
  };
  const canWrite = {{if hasPermission .CurrentUser "fleet:write"}}true{{else}}false{{end}};

  const activeAlertsEl = document.getElementById('active-alerts');
  const activeAlertCountEl = document.getElementById('active-alert-count');
  const rulesBodyEl = document.getElementById('rules-body');
  const rulesCountEl = document.getElementById('rules-count');

  const createBtn = document.getElementById('create-rule-btn');
  const createPanel = document.getElementById('alerts-create-panel');
  const createForm = document.getElementById('create-rule-form');
  const createCloseTargets = document.querySelectorAll('[data-create-close]');

  const typeInput = document.getElementById('rule-type');
  const thresholdWrap = document.getElementById('threshold-wrap');
  const thresholdInput = document.getElementById('rule-threshold');

  function showToast(message, kind) {
    if (window.LegatorUI && window.LegatorUI.showToast) {
      window.LegatorUI.showToast(message, kind || 'info');
    }
  }

  function escapeHTML(value) {
    return String(value || '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  }

  function fmtTime(value) {
    if (!value) return '—';
    const parsed = new Date(value);
    if (Number.isNaN(parsed.getTime())) return '—';
    return parsed.toLocaleString();
  }

  function setCreatePanelOpen(isOpen) {
    document.body.classList.toggle('alerts-create-open', isOpen);
    createPanel.setAttribute('aria-hidden', String(!isOpen));
  }

  function parseTags(input) {
    return (input || '')
      .split(',')
      .map((t) => t.trim())
      .filter(Boolean);
  }

  function conditionThreshold(rule) {
    const type = rule?.condition?.type || '';
    if (type === 'disk_threshold' || type === 'cpu_threshold') {
      return rule?.condition?.threshold ?? '—';
    }
    return '—';
  }

  function updateThresholdVisibility() {
    const type = typeInput.value;
    const needsThreshold = type === 'disk_threshold' || type === 'cpu_threshold';
    thresholdWrap.style.display = needsThreshold ? 'block' : 'none';
    thresholdInput.required = needsThreshold;
    if (!needsThreshold) {
      thresholdInput.value = '0';
    } else if (!thresholdInput.value || Number(thresholdInput.value) <= 0) {
      thresholdInput.value = '90';
    }
  }

  async function requestJSON(url, options) {
    const response = await fetch(url, {
      credentials: 'include',
      ...options,
    });

    if (!response.ok) {
      let detail = response.statusText;
      try {
        const body = await response.json();
        detail = body?.message || body?.error || detail;
      } catch {}
      throw new Error(detail || 'Request failed');
    }

    if (response.status === 204) {
      return null;
    }

    return response.json();
  }

  function renderActiveAlerts(alerts) {
    const active = Array.isArray(alerts) ? alerts : [];
    activeAlertCountEl.textContent = `${active.length} firing`;

    if (!active.length) {
      activeAlertsEl.innerHTML = '<p class="muted">No active alerts.</p>';
      return;
    }

    activeAlertsEl.innerHTML = active.map((alert) => {
      return `
        <article class="panel">
          <div class="panel-header">
            <span class="panel-title">${escapeHTML(alert.rule_name || 'Unnamed rule')}</span>
            <span class="tag tag-degraded">firing</span>
          </div>
          <p class="muted">Probe: <span class="id-text">${escapeHTML(alert.probe_id || '—')}</span> · Since ${fmtTime(alert.fired_at)}</p>
          <p>${escapeHTML(alert.message || 'No message')}</p>
        </article>
      `;
    }).join('');
  }

  function renderHistoryEvents(ruleID, events) {
    const list = Array.isArray(events) ? events : [];
    if (!list.length) {
      return '<p class="muted">No history events for this rule.</p>';
    }

    return `<div class="feed">${list.map((event) => `
      <article class="panel">
        <div class="panel-header">
          <span class="tag ${(event.status || '').toLowerCase() === 'resolved' ? 'tag-online' : 'tag-degraded'}">${escapeHTML(event.status || 'unknown')}</span>
          <span class="muted">${fmtTime(event.resolved_at || event.fired_at)}</span>
        </div>
        <p><strong>Probe:</strong> <span class="id-text">${escapeHTML(event.probe_id || '—')}</span></p>
        <p><strong>Message:</strong> ${escapeHTML(event.message || '—')}</p>
      </article>
    `).join('')}</div>`;
  }

  function renderRules() {
    const rules = Array.isArray(state.rules) ? state.rules : [];
    rulesCountEl.textContent = `${rules.length} rules`;

    if (!rules.length) {
      rulesBodyEl.innerHTML = '<tr><td colspan="7" class="empty-state">No alert rules configured.</td></tr>';
      return;
    }

    rulesBodyEl.innerHTML = rules.map((rule) => {
      const tags = Array.isArray(rule.condition?.tags) && rule.condition.tags.length
        ? rule.condition.tags.map((tag) => `<span class="tag">${escapeHTML(tag)}</span>`).join(' ')
        : '<span class="muted">—</span>';

      const historyVisible = Boolean(state.history[rule.id]?.visible);
      const historyCell = state.history[rule.id]?.loading
        ? '<p class="muted">Loading history…</p>'
        : renderHistoryEvents(rule.id, state.history[rule.id]?.events || []);

      return `
        <tr data-rule-id="${escapeHTML(rule.id)}">
          <td>${escapeHTML(rule.name || '—')}</td>
          <td>${escapeHTML(rule.condition?.type || '—')}</td>
          <td>${escapeHTML(conditionThreshold(rule))}</td>
          <td>${escapeHTML(rule.condition?.duration || '—')}</td>
          <td>${tags}</td>
          <td>
            <label>
              <input type="checkbox" data-toggle-rule="${escapeHTML(rule.id)}" ${rule.enabled ? 'checked' : ''} ${canWrite ? '' : 'disabled'} />
              <span>${rule.enabled ? 'On' : 'Off'}</span>
            </label>
          </td>
          <td>
            <div class="actions-row">
              <button type="button" class="btn" data-history-rule="${escapeHTML(rule.id)}">History</button>
              ${canWrite ? `<button type="button" class="btn btn-danger" data-delete-rule="${escapeHTML(rule.id)}">Delete</button>` : '<span class="muted">Read-only</span>'}
            </div>
          </td>
        </tr>
        <tr data-history-row="${escapeHTML(rule.id)}" ${historyVisible ? '' : 'style="display:none;"'}>
          <td colspan="7">${historyCell}</td>
        </tr>
      `;
    }).join('');
  }

  async function refreshActiveAlerts() {
    try {
      const payload = await requestJSON('/api/v1/alerts/active', { cache: 'no-store' });
      renderActiveAlerts(payload?.alerts || []);
    } catch {
      activeAlertsEl.innerHTML = '<p class="muted">Failed to load active alerts.</p>';
    }
  }

  async function refreshRules() {
    try {
      state.rules = await requestJSON('/api/v1/alerts', { cache: 'no-store' });
      renderRules();
    } catch (error) {
      rulesBodyEl.innerHTML = `<tr><td colspan="7" class="empty-state">Failed to load rules: ${escapeHTML(error.message)}</td></tr>`;
    }
  }

  async function updateRuleEnabled(ruleID, enabled) {
    if (!canWrite) {
      showToast('fleet:write permission is required to edit alert rules', 'warning');
      renderRules();
      return;
    }

    const rule = state.rules.find((item) => item.id === ruleID);
    if (!rule) return;

    try {
      await requestJSON(`/api/v1/alerts/${encodeURIComponent(ruleID)}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: rule.name,
          description: rule.description || '',
          enabled,
          condition: {
            type: rule.condition?.type || 'probe_offline',
            threshold: Number(rule.condition?.threshold || 0),
            duration: rule.condition?.duration || '1m',
            tags: Array.isArray(rule.condition?.tags) ? rule.condition.tags : [],
          },
          actions: Array.isArray(rule.actions) ? rule.actions : [],
        }),
      });

      rule.enabled = enabled;
      renderRules();
      showToast(enabled ? 'Rule enabled' : 'Rule disabled', 'success');
    } catch (error) {
      showToast(`Failed to update rule: ${error.message}`, 'error');
      renderRules();
    }
  }

  async function deleteRule(ruleID) {
    if (!canWrite) {
      showToast('fleet:write permission is required to delete alert rules', 'warning');
      return;
    }

    if (!window.confirm('Delete this alert rule?')) {
      return;
    }

    try {
      await requestJSON(`/api/v1/alerts/${encodeURIComponent(ruleID)}`, {
        method: 'DELETE',
      });
      showToast('Rule deleted', 'success');
      delete state.history[ruleID];
      await refreshRules();
      await refreshActiveAlerts();
    } catch (error) {
      showToast(`Failed to delete rule: ${error.message}`, 'error');
    }
  }

  async function toggleHistory(ruleID) {
    const current = state.history[ruleID] || { visible: false, loading: false, events: [] };

    if (current.visible) {
      state.history[ruleID] = { ...current, visible: false };
      renderRules();
      return;
    }

    state.history[ruleID] = { ...current, visible: true };
    renderRules();

    if (current.events && current.events.length) {
      return;
    }

    state.history[ruleID] = { ...state.history[ruleID], loading: true };
    renderRules();

    try {
      const payload = await requestJSON(`/api/v1/alerts/${encodeURIComponent(ruleID)}/history?limit=20`, {
        cache: 'no-store',
      });
      state.history[ruleID] = {
        visible: true,
        loading: false,
        events: Array.isArray(payload?.events) ? payload.events : [],
      };
    } catch (error) {
      state.history[ruleID] = {
        visible: true,
        loading: false,
        events: [],
      };
      showToast(`Failed to load rule history: ${error.message}`, 'error');
    }

    renderRules();
  }

  rulesBodyEl.addEventListener('change', (event) => {
    const checkbox = event.target.closest('[data-toggle-rule]');
    if (!checkbox) return;
    const ruleID = checkbox.getAttribute('data-toggle-rule');
    if (!canWrite) {
      renderRules();
      return;
    }
    void updateRuleEnabled(ruleID, checkbox.checked);
  });

  rulesBodyEl.addEventListener('click', (event) => {
    const historyBtn = event.target.closest('[data-history-rule]');
    if (historyBtn) {
      const ruleID = historyBtn.getAttribute('data-history-rule');
      void toggleHistory(ruleID);
      return;
    }

    const deleteBtn = event.target.closest('[data-delete-rule]');
    if (deleteBtn) {
      const ruleID = deleteBtn.getAttribute('data-delete-rule');
      void deleteRule(ruleID);
    }
  });

  if (!canWrite) {
    createBtn.setAttribute('disabled', 'disabled');
    createBtn.setAttribute('title', 'fleet:write permission required');
  }

  createBtn.addEventListener('click', () => {
    if (!canWrite) {
      showToast('fleet:write permission is required to create alert rules', 'warning');
      return;
    }
    setCreatePanelOpen(true);
  });
  createCloseTargets.forEach((target) => {
    target.addEventListener('click', () => setCreatePanelOpen(false));
  });

  document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape' && document.body.classList.contains('alerts-create-open')) {
      setCreatePanelOpen(false);
    }
  });

  typeInput.addEventListener('change', updateThresholdVisibility);

  createForm.addEventListener('submit', async (event) => {
    event.preventDefault();

    if (!canWrite) {
      showToast('fleet:write permission is required to create alert rules', 'warning');
      return;
    }

    const ruleType = typeInput.value;
    const needsThreshold = ruleType === 'disk_threshold' || ruleType === 'cpu_threshold';

    const payload = {
      name: document.getElementById('rule-name').value.trim(),
      description: document.getElementById('rule-description').value.trim(),
      enabled: document.getElementById('rule-enabled').checked,
      condition: {
        type: ruleType,
        threshold: needsThreshold ? Number(thresholdInput.value || 0) : 0,
        duration: document.getElementById('rule-duration').value.trim(),
        tags: parseTags(document.getElementById('rule-tags').value),
      },
      actions: [],
    };

    try {
      await requestJSON('/api/v1/alerts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      showToast('Alert rule created', 'success');
      createForm.reset();
      document.getElementById('rule-enabled').checked = true;
      typeInput.value = 'probe_offline';
      updateThresholdVisibility();
      setCreatePanelOpen(false);
      await refreshRules();
      await refreshActiveAlerts();
    } catch (error) {
      showToast(`Failed to create rule: ${error.message}`, 'error');
    }
  });

  updateThresholdVisibility();
  refreshActiveAlerts();
  refreshRules();
})();
</script>
{{end}}
