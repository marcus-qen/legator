{{define "title"}}Cloud Connectors — Legator{{end}}

{{define "header"}}
<div>
  <h1 class="page-title">Cloud Connectors</h1>
  <span class="page-meta">Manual cloud inventory scans via AWS/GCP/Azure CLIs</span>
</div>
<div class="right">
  <button class="btn" type="button" id="refresh-cloud-connectors">Refresh</button>
</div>
{{end}}

{{define "content"}}
<section class="panel">
  <div class="panel-header">
    <h2 class="panel-title">Connectors</h2>
    <span class="panel-sub" id="connectors-count">0 connectors</span>
  </div>
  <div class="table-wrap">
    <table class="data-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Provider</th>
          <th>Auth</th>
          <th>Enabled</th>
          <th>Last Scan</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="connectors-body">
        <tr><td colspan="7" class="empty-state">Loading connectors…</td></tr>
      </tbody>
    </table>
  </div>
</section>

<section class="panel">
  <div class="panel-header">
    <h2 class="panel-title" id="connector-form-title">Create Connector</h2>
    <button type="button" class="btn" id="connector-form-reset">Reset</button>
  </div>
  <form id="connector-form" class="feed" autocomplete="off">
    <input type="hidden" id="connector-id" />

    <label>
      <span class="muted">Name</span>
      <input class="input" id="connector-name" required />
    </label>

    <div class="grid-two cloud-form-grid">
      <label>
        <span class="muted">Provider</span>
        <select class="input" id="connector-provider" required>
          <option value="aws">AWS</option>
          <option value="gcp">GCP</option>
          <option value="azure">Azure</option>
        </select>
      </label>

      <label>
        <span class="muted">Auth mode</span>
        <input class="input" id="connector-auth-mode" value="cli" readonly />
      </label>
    </div>

    <label>
      <input type="checkbox" id="connector-enabled" checked />
      <span>Enabled</span>
    </label>

    <div class="actions-row">
      <button class="btn btn-primary" type="submit" id="connector-submit">Create</button>
      <button class="btn" type="button" id="connector-cancel">Cancel</button>
    </div>
  </form>
</section>

<section class="panel">
  <div class="panel-header">
    <h2 class="panel-title">Latest Assets</h2>
    <div class="right">
      <select class="input" id="assets-provider-filter">
        <option value="">All providers</option>
        <option value="aws">AWS</option>
        <option value="gcp">GCP</option>
        <option value="azure">Azure</option>
      </select>
      <select class="input" id="assets-connector-filter">
        <option value="">All connectors</option>
      </select>
    </div>
  </div>

  <div class="table-wrap">
    <table class="data-table">
      <thead>
        <tr>
          <th>Provider</th>
          <th>Connector</th>
          <th>Scope</th>
          <th>Region</th>
          <th>Type</th>
          <th>Asset ID</th>
          <th>Name</th>
          <th>Status</th>
          <th>Discovered</th>
        </tr>
      </thead>
      <tbody id="assets-body">
        <tr><td colspan="9" class="empty-state">Loading assets…</td></tr>
      </tbody>
    </table>
  </div>
</section>
{{end}}

{{define "scripts"}}
<script>
(() => {
  const state = {
    connectors: [],
    assets: [],
  };
  const canWrite = {{if hasPermission .CurrentUser "fleet:write"}}true{{else}}false{{end}};

  const connectorsBody = document.getElementById('connectors-body');
  const connectorsCount = document.getElementById('connectors-count');
  const assetsBody = document.getElementById('assets-body');

  const form = document.getElementById('connector-form');
  const formTitle = document.getElementById('connector-form-title');
  const submitBtn = document.getElementById('connector-submit');
  const formResetBtn = document.getElementById('connector-form-reset');
  const cancelBtn = document.getElementById('connector-cancel');

  const connectorId = document.getElementById('connector-id');
  const connectorName = document.getElementById('connector-name');
  const connectorProvider = document.getElementById('connector-provider');
  const connectorAuthMode = document.getElementById('connector-auth-mode');
  const connectorEnabled = document.getElementById('connector-enabled');

  const providerFilter = document.getElementById('assets-provider-filter');
  const connectorFilter = document.getElementById('assets-connector-filter');

  function toast(message, kind) {
    if (window.LegatorUI?.showToast) {
      window.LegatorUI.showToast(message, kind || 'info');
    }
  }

  function esc(value) {
    return String(value || '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  }

  function formatTime(value) {
    if (!value) return '—';
    const dt = new Date(value);
    if (Number.isNaN(dt.getTime())) return value;
    return dt.toLocaleString();
  }

  function statusTag(connector) {
    const status = (connector.last_status || '').toLowerCase();
    if (status === 'success') {
      return '<span class="tag tag-online">success</span>';
    }
    if (status === 'error') {
      const detail = connector.last_error ? ` title="${esc(connector.last_error)}"` : '';
      return `<span class="tag tag-offline"${detail}>error</span>`;
    }
    return '<span class="tag">never</span>';
  }

  function findConnectorName(connectorId) {
    const match = state.connectors.find((item) => item.id === connectorId);
    return match?.name || connectorId || '—';
  }

  async function requestJSON(url, options) {
    const response = await fetch(url, {
      credentials: 'include',
      cache: 'no-store',
      ...options,
    });

    let payload = null;
    if (response.status !== 204) {
      try {
        payload = await response.json();
      } catch {
        payload = null;
      }
    }

    if (!response.ok) {
      const message = payload?.error || payload?.message || response.statusText || 'Request failed';
      throw new Error(message);
    }

    return payload;
  }

  function renderConnectorFilter() {
    const current = connectorFilter.value;
    connectorFilter.innerHTML = '<option value="">All connectors</option>' + state.connectors
      .map((connector) => `<option value="${esc(connector.id)}">${esc(connector.name)}</option>`)
      .join('');
    connectorFilter.value = current;
  }

  function renderConnectors() {
    connectorsCount.textContent = `${state.connectors.length} connectors`;
    renderConnectorFilter();

    if (!state.connectors.length) {
      connectorsBody.innerHTML = '<tr><td colspan="7" class="empty-state">No connectors configured yet.</td></tr>';
      return;
    }

    connectorsBody.innerHTML = state.connectors.map((connector) => `
      <tr>
        <td>${esc(connector.name)}</td>
        <td>${esc(connector.provider)}</td>
        <td>${esc(connector.auth_mode || 'cli')}</td>
        <td>${connector.is_enabled ? '<span class="tag tag-online">enabled</span>' : '<span class="tag">disabled</span>'}</td>
        <td>${esc(formatTime(connector.last_scan_at))}</td>
        <td>${statusTag(connector)}</td>
        <td>
          <div class="actions-row">
            ${canWrite
              ? `<button class="btn" type="button" data-action="edit" data-id="${esc(connector.id)}">Edit</button>
                 <button class="btn" type="button" data-action="scan" data-id="${esc(connector.id)}">Scan</button>
                 <button class="btn btn-danger" type="button" data-action="delete" data-id="${esc(connector.id)}">Delete</button>`
              : '<span class="muted">Read-only</span>'}
          </div>
        </td>
      </tr>
    `).join('');
  }

  function renderAssets() {
    if (!state.assets.length) {
      assetsBody.innerHTML = '<tr><td colspan="9" class="empty-state">No assets found. Run a connector scan.</td></tr>';
      return;
    }

    assetsBody.innerHTML = state.assets.map((asset) => `
      <tr>
        <td>${esc(asset.provider)}</td>
        <td>${esc(findConnectorName(asset.connector_id))}</td>
        <td>${esc(asset.scope_id || '—')}</td>
        <td>${esc(asset.region || '—')}</td>
        <td>${esc(asset.asset_type)}</td>
        <td class="id-text">${esc(asset.asset_id)}</td>
        <td>${esc(asset.display_name || '—')}</td>
        <td>${esc(asset.status || '—')}</td>
        <td>${esc(formatTime(asset.discovered_at))}</td>
      </tr>
    `).join('');
  }

  function setEditMode(connector) {
    formTitle.textContent = `Edit Connector: ${connector.name}`;
    submitBtn.textContent = 'Save';

    connectorId.value = connector.id;
    connectorName.value = connector.name || '';
    connectorProvider.value = connector.provider || 'aws';
    connectorAuthMode.value = connector.auth_mode || 'cli';
    connectorEnabled.checked = Boolean(connector.is_enabled);
    connectorName.focus();
  }

  function resetForm() {
    formTitle.textContent = 'Create Connector';
    submitBtn.textContent = 'Create';
    connectorId.value = '';
    form.reset();
    connectorProvider.value = 'aws';
    connectorAuthMode.value = 'cli';
    connectorEnabled.checked = true;
  }

  async function loadConnectors() {
    const payload = await requestJSON('/api/v1/cloud/connectors');
    state.connectors = Array.isArray(payload?.connectors) ? payload.connectors : [];
    renderConnectors();
  }

  async function loadAssets() {
    const params = new URLSearchParams();
    if (providerFilter.value) params.set('provider', providerFilter.value);
    if (connectorFilter.value) params.set('connector_id', connectorFilter.value);
    params.set('limit', '200');

    const payload = await requestJSON(`/api/v1/cloud/assets?${params.toString()}`);
    state.assets = Array.isArray(payload?.assets) ? payload.assets : [];
    renderAssets();
  }

  async function refreshAll() {
    await loadConnectors();
    await loadAssets();
  }

  connectorsBody.addEventListener('click', async (event) => {
    const button = event.target.closest('button[data-action]');
    if (!button) return;

    if (!canWrite) {
      toast('fleet:write permission is required to manage connectors', 'warning');
      return;
    }

    const action = button.dataset.action;
    const id = button.dataset.id;
    const connector = state.connectors.find((item) => item.id === id);
    if (!connector) return;

    if (action === 'edit') {
      setEditMode(connector);
      return;
    }

    if (action === 'scan') {
      button.disabled = true;
      try {
        await requestJSON(`/api/v1/cloud/connectors/${encodeURIComponent(id)}/scan`, { method: 'POST' });
        toast('Scan completed', 'success');
      } catch (error) {
        toast(`Scan failed: ${error.message}`, 'error');
      } finally {
        button.disabled = false;
      }
      await refreshAll();
      return;
    }

    if (action === 'delete') {
      if (!window.confirm(`Delete connector “${connector.name}”?`)) return;
      try {
        await requestJSON(`/api/v1/cloud/connectors/${encodeURIComponent(id)}`, { method: 'DELETE' });
        if (connectorId.value === id) {
          resetForm();
        }
        toast('Connector deleted', 'success');
        await refreshAll();
      } catch (error) {
        toast(`Delete failed: ${error.message}`, 'error');
      }
    }
  });

  form.addEventListener('submit', async (event) => {
    event.preventDefault();

    if (!canWrite) {
      toast('fleet:write permission is required to save connectors', 'warning');
      return;
    }

    const id = connectorId.value.trim();
    const payload = {
      name: connectorName.value.trim(),
      provider: connectorProvider.value.trim(),
      auth_mode: connectorAuthMode.value.trim() || 'cli',
      is_enabled: connectorEnabled.checked,
    };

    try {
      if (id) {
        await requestJSON(`/api/v1/cloud/connectors/${encodeURIComponent(id)}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        toast('Connector updated', 'success');
      } else {
        await requestJSON('/api/v1/cloud/connectors', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        toast('Connector created', 'success');
      }

      resetForm();
      await refreshAll();
    } catch (error) {
      toast(`Save failed: ${error.message}`, 'error');
    }
  });

  document.getElementById('refresh-cloud-connectors').addEventListener('click', async () => {
    try {
      await refreshAll();
      toast('Cloud connectors refreshed', 'success');
    } catch (error) {
      toast(`Refresh failed: ${error.message}`, 'error');
    }
  });
  formResetBtn.addEventListener('click', resetForm);
  cancelBtn.addEventListener('click', resetForm);

  if (!canWrite) {
    formTitle.textContent = 'Connectors (read-only)';
    submitBtn.setAttribute('disabled', 'disabled');
    submitBtn.textContent = 'Read-only';
    formResetBtn.setAttribute('disabled', 'disabled');
    cancelBtn.setAttribute('disabled', 'disabled');
    [connectorName, connectorProvider, connectorAuthMode, connectorEnabled].forEach((el) => {
      el.setAttribute('disabled', 'disabled');
    });
  }
  providerFilter.addEventListener('change', loadAssets);
  connectorFilter.addEventListener('change', loadAssets);

  refreshAll().catch((error) => {
    toast(`Failed to load cloud connectors: ${error.message}`, 'error');
  });
})();
</script>
{{end}}
