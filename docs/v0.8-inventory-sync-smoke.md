# v0.8.0 Inventory Sync Smoke Test

Validates Headscale inventory wiring and sync freshness metadata.

---

## Preconditions

- Legator controller deployed with:
  - `HEADSCALE_API_URL`
  - `HEADSCALE_API_KEY`
  - API server enabled (`--api-bind-address`)
- CLI logged in (`legator login`)

---

## 1) Verify inventory endpoint returns sync metadata

```bash
curl -sS -H "Authorization: Bearer $TOKEN" "$LEGATOR_API_URL/api/v1/inventory" | jq .
```

Expected:
- `source: "inventory-provider"`
- `sync` object present
- `sync.provider: "headscale"`
- `sync.lastSuccess` populated after successful sync
- `sync.stale: false` on healthy recent syncs
- `sync.healthy: true`

---

## 2) Verify CLI surfaces sync status

```bash
legator inventory
```

Expected output contains:
- device list
- `Sync status` block
- provider/healthy/last sync fields

Optional detail check:

```bash
legator inventory show <device-name>
```

---

## 3) Failure-path check (optional)

Temporarily break Headscale credentials/config and confirm:
- inventory call still responds
- `sync.healthy: false`
- `sync.lastError` populated
- `consecutiveFailures` increments

Restore credentials and verify recovery to healthy state.

---

## Evidence to capture

- `/api/v1/inventory` JSON (redact tokens)
- `legator inventory` output snippet showing sync status
- one failure-path sample (if executed)
