# v0.8.0 Auth + RBAC Smoke Test Matrix

This runbook validates the human auth path added in v0.8.0:

- OIDC device login (`legator login`)
- identity + permission introspection (`legator whoami`)
- role enforcement (viewer/operator/admin)

---

## Preconditions

- Legator API reachable at your chosen URL (example: `https://legator.lab.k-dev.uk`)
- OIDC issuer reachable (example: `https://keycloak.lab.k-dev.uk/realms/dev-lab`)
- Three test users exist (one per role)
- CLI binary includes `login`, `logout`, `whoami`

Environment variables (recommended):

```bash
export LEGATOR_API_URL="https://legator.lab.k-dev.uk"
export LEGATOR_OIDC_ISSUER="https://keycloak.lab.k-dev.uk/realms/dev-lab"
export LEGATOR_OIDC_CLIENT_ID="legator-cli"
```

---

## Fast identity check workflow

```bash
legator logout
legator login --api-url "$LEGATOR_API_URL"
legator whoami
```

Expected:
- login succeeds
- `whoami` shows email, groups, effective role
- permissions table is present

---

## Role matrix

Repeat the login flow with each test user.

### Viewer

Expected permissions:
- ✅ `agents:view`, `runs:view`, `inventory:view`, `audit:view`
- ❌ `agents:run`, `approvals:decide`, `config:write`

Validation commands:

```bash
legator whoami
legator agents list            # should succeed
legator run watchman-light --task "viewer test"   # should be denied
```

### Operator

Expected permissions:
- ✅ all viewer permissions
- ✅ `agents:run`, `approvals:decide`
- ❌ `config:write`

Validation commands:

```bash
legator whoami
legator run watchman-light --task "operator test"
# if there is a pending approval:
legator approvals
```

### Admin

Expected permissions:
- ✅ all operator permissions
- ✅ `config:write`

Validation commands:

```bash
legator whoami
legator run watchman-light --task "admin test"
```

---

## Failure triage

If login works but verification fails:

- check `--api-url` value
- confirm API endpoint `/api/v1/me` is reachable
- verify API OIDC issuer/audience config
- check token audience + groups claims from IdP

If role mapping is wrong:

- inspect `whoami` group claims
- verify API RBAC policy group names
- confirm user is in correct Keycloak group/role

---

## Evidence to capture

- `legator whoami` output for each role
- one denied action screenshot/log (viewer run attempt)
- one successful action per allowed role
- API logs for auth decisions during test window
