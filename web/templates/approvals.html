{{define "title"}}Approvals — Legator{{end}}

{{define "header"}}
<div>
  <h1 class="page-title">Approvals</h1>
  <span class="page-meta">Human-in-the-loop queue</span>
</div>
{{end}}

{{define "content"}}
<section class="panel">
  <div class="stat-row">
    <span>Pending: <strong id="pending-count">0</strong></span>
  </div>
</section>

<section id="approvals-list" class="feed"></section>

<section id="empty-state" class="panel empty-state hidden">
  All clear — no pending approvals.
</section>
{{end}}

{{define "scripts"}}
<script>
(() => {
  const decidedBy = {{if .CurrentUser}}"{{.CurrentUser.Username}}"{{else}}"operator"{{end}};

  function riskClass(risk) {
    const r = (risk || '').toLowerCase();
    if (r === 'high' || r === 'critical') return 'tag-offline';
    if (r === 'medium') return 'tag-degraded';
    return 'tag-online';
  }

  function fmtTime(value) {
    if (!value) return '—';
    return new Date(value).toLocaleString();
  }

  function notify(message, ok) {
    if (window.LegatorUI && window.LegatorUI.showToast) {
      window.LegatorUI.showToast(message, ok ? 'success' : 'error');
    }
  }

  function normalizeApprovals(payload) {
    if (Array.isArray(payload)) return payload;
    if (payload && Array.isArray(payload.approvals)) return payload.approvals;
    return [];
  }

  function decide(id, decision) {
    fetch('/api/v1/approvals/' + encodeURIComponent(id) + '/decide', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ decision, decided_by: decidedBy }),
    })
      .then(async (resp) => {
        if (!resp.ok) {
          const msg = await resp.text();
          throw new Error(msg || `status ${resp.status}`);
        }
        notify(decision === 'approved' ? 'Approval granted' : 'Request denied', true);
        refresh();
      })
      .catch((err) => notify('Failed: ' + err.message, false));
  }

  window.approvalsDecide = decide;

  function render(items) {
    const list = document.getElementById('approvals-list');
    const empty = document.getElementById('empty-state');
    const pending = items.filter((item) => (item.decision || item.status) === 'pending');

    document.getElementById('pending-count').textContent = String(pending.length);

    if (!pending.length) {
      list.innerHTML = '';
      empty.classList.remove('hidden');
      return;
    }

    empty.classList.add('hidden');
    list.innerHTML = pending.map((approval) => {
      const risk = approval.risk_level || approval.risk || 'unknown';
      return `
        <article class="panel">
          <div class="panel-header">
            <h2 class="panel-title"><span class="tag ${riskClass(risk)}">${String(risk).toUpperCase()}</span> ${approval.probe_id || 'unknown probe'}</h2>
            <span class="panel-sub">${fmtTime(approval.created_at || approval.submitted_at)}</span>
          </div>
          <pre class="chat-code">${JSON.stringify(approval.command || approval.task || approval, null, 2)}</pre>
          <div class="actions-row">
            <button class="btn btn-primary" onclick="approvalsDecide('${approval.id}','approved')">Approve</button>
            <button class="btn btn-danger" onclick="approvalsDecide('${approval.id}','denied')">Deny</button>
          </div>
          <div class="muted">Approval ID: <span class="id-text">${approval.id}</span></div>
        </article>
      `;
    }).join('');
  }

  function refresh() {
    fetch('/api/v1/approvals?status=pending', { cache: 'no-store' })
      .then((resp) => resp.json())
      .then((payload) => render(normalizeApprovals(payload)))
      .catch(() => {});
  }

  refresh();
  setInterval(refresh, 5000);
})();
</script>
{{end}}
